<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/main.css"/>
</head>
<body>
<nav>
    <ul>
        <li>
            <p id="time"></p>
        </li>
        <li>
            <form id="trail-form" class='form-inline' action="#" onsubmit="return makeVisible(this)">
                <label for="start">Start Date</label>
                <input id="start" type="date">
                <label for="end">End Date</label>
                <input id="end" type="date">
                <input type="submit" class="btn btn-default">
            </form>
        </li>
        <li>
            <!--put stuff here-->
        </li>
    </ul>
</nav>

<script src="//d3js.org/d3.v3.min.js"></script>
<script type="text/javascript" src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>
    'use strict';

    // add ability (force user?) to subset by month

    var width = 800;
    var height = 600;
    var vis = d3.select("body").append("svg")
            .attr("width", width).attr("height", height);

    var city = vis.append('g');
    var trips = vis.append('g');

    var scaleTime = 1000;

    d3.json("city-limits.geojson", function(error, outline) {
        var center = d3.geo.centroid(outline);
        var scale = 200000;
        var offset = [670, 410];

        // new projection
        var projection = d3.geo.mercator().center(center)
                .scale(scale).translate(offset).rotate([0,0,0]);

        var path = d3.geo.path().projection(projection);

        city.selectAll("path").data(outline.features).enter().append("path")
                .attr("d", path)
                .style("stroke-width", "1")
                .style("fill", 'white')
                .style("stroke", "black");
        d3.csv("2015_trip_data.csv", function(error, tripData) {
            var links = [];
            for(var i = 0; i < tripData.length; i++){
                links.push({
                    coordinates: [
                        { lon: tripData[i].startlon, lat: tripData[i].startlat},
                        { lon: tripData[i].endlon, lat: tripData[i].endlat }
                    ],
                    timestamps: {start: new Date(tripData[i].starttime), end: new Date(tripData[i].stoptime)},
                    demographics: {
                        member: tripData[i].usertype === 'Annual Member',
                        gender: tripData[i].gender,
                        birthYear: tripData[i].birthyear
                    }
                });
            }

            links = links.slice(0, 1000);

            var earliest = links[0].timestamps.start; //data is sorted
            var last = links[links.length - 1].timestamps.end;

            for (var idx = 0; idx < links.length; idx++) {
                var wait = (links[idx].timestamps.start - earliest) / scaleTime;
                console.log(wait);
                var duration = (links[idx].timestamps.end - links[idx].timestamps.start) / scaleTime;
                drawTrips(projection, trips.append('g'),links[idx], wait, duration);
            }
            clock(earliest, last);
        });
    });

    function drawTrips(projection, layer, link, wait, duration) {
        var line = d3.svg.line()
                .x(function (d) {
                    return projection([d.lon,])[0]
                })
                .y(function (d) {
                    return projection([, d.lat])[1]
                })
                .interpolate("linear");

        var tripPath = layer.append("path")
                .attr("d", line(link.coordinates))
                .attr("stroke", "steelblue")
                .attr("stroke-width", "1")
                .attr("fill", "none")
                .attr("class", link.timestamps);

        var tripLength = tripPath.node().getTotalLength();

        //fade in
        tripPath.attr("stroke-dasharray", tripLength + " " + tripLength)
                .attr("stroke-dashoffset", -tripLength) // - to correct direction
                .attr('class', 'trail')
                .transition()
                .delay(wait)
                .duration(duration)
                .ease("linear")
                .attr("stroke-dashoffset", 0)
                // change color
                .transition()
                .attr("stroke", 'lightblue')
                // fade away
                .transition()
                .duration(10)
                .style('opacity', 0);
                // erase
//                .transition()
//                .duration(duration * 4)
//                .ease("linear")
//                .attr("stroke-dashoffset", tripLength)
//                .remove();
    }

    function clock(start, end) {
        var date = start;
        setInterval(function() {
            if (date <= end) {
                d3.select('#time').text(date);
                date.setTime(date.getTime() + 100 * scaleTime);
            }
        }, 100);
    }

    d3.select('#trail-form').on('submit', function() {});

    function makeVisible(form) {
        d3.selectAll('.trail')
                .call(function(d) {
                    console.log(form.end.value);
                    console.log(d[0]);
                    return [d[0].filter(function(el) {
                        console.log(el);
                        return el.timestamps.end <= form.end.value &&
                                        el.timestamps.start >= form.start.value
                    })]
                })
                .style('opacity', 100)

    }

    function changeMonth() {}

    function filterSubscription() { }


</script>
</body>
</html>